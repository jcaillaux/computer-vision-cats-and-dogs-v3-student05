apiVersion: 1

groups:
  - orgId: 1
    name: cv-monitoring
    folder: Computer Vision
    interval: 1m
    
    rules:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ”´ ALERTE 1 : Base de donnÃ©es dÃ©connectÃ©e (CRITICAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-db-disconnected
        title: Database Disconnected
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: cv_database_connected
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          description: L'API ne peut plus accÃ©der Ã  PostgreSQL
          summary: Base de donnÃ©es PostgreSQL dÃ©connectÃ©e
        labels:
          severity: critical
        isPaused: false

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 2 : Latence d'infÃ©rence Ã©levÃ©e (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-high-latency
        title: High Inference Latency
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: rate(cv_inference_time_seconds_sum[5m]) / rate(cv_inference_time_seconds_count[5m])
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: OK
        execErrState: Error
        for: 1m
        annotations:
          description: "La latence moyenne d'infÃ©rence dÃ©passe 2 secondes depuis 2 minutes. VÃ©rifier charge CPU/GPU et modÃ¨le."
          summary: "Latence d'infÃ©rence Ã©levÃ©e (> 2s)"
        labels:
          severity: warning
          component: inference
        isPaused: false
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ ALERTE 3 : Feedback nÃ©gatifs (WARNING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - uid: cv-high-negative-feedback
        title: High Negative Feedback Rate
        condition: C
        intervalSeconds: 30
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(cv_user_feedback_total{feedback="0"}[5m])) / sum(rate(cv_user_feedback_total[5m]))
              instant: true
              range: false
              refId: A
          
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.5  # 50%
                    type: gt
                  reducer:
                    type: last
                  type: query
              expression: A
              type: threshold
        
        noDataState: OK
        execErrState: Alerting  # Alerte si pas de donnÃ©es (peut indiquer un problÃ¨me)
        for: 10m  # Pendant 10 minutes
        annotations:
          description: "Le taux de feedback nÃ©gatif dÃ©passe 50% depuis 10 minutes. VÃ©rifier la qualitÃ© des infÃ©rences et l'expÃ©rience utilisateur."
          summary: "Taux Ã©levÃ© de feedbacks nÃ©gatifs (> 50%)"
        labels:
          severity: critical  # Plus grave que warning
          component: feedback
        isPaused: false