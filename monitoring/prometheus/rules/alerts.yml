# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš¨ PROMETHEUS ALERTING RULES - DÃ©tection d'anomalies ML
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ OBJECTIF PÃ‰DAGOGIQUE
# Fichier dÃ©finissant les rÃ¨gles d'alerte Prometheus pour monitoring proactif.
# Illustre comment transformer mÃ©triques brutes en alertes actionnables basÃ©es
# sur des seuils mÃ©tier et SLA (Service Level Agreements).
#
# ğŸ“š CONCEPTS CLÃ‰S
# - Recording rules vs Alerting rules (ici : alerting)
# - Expressions PromQL : aggregations, quantiles, taux
# - Labels de sÃ©vÃ©ritÃ© : classification des incidents
# - Clause "for" : durÃ©e avant dÃ©clenchement (Ã©vite faux positifs)
# - Annotations : contexte pour l'Ã©quipe (summary, description, runbook)
#
# ğŸ”— INTÃ‰GRATION
# - ChargÃ© par : monitoring/prometheus/prometheus.yml (rule_files)
# - Ã‰valuÃ© toutes les : 30s (interval du groupe)
# - Notifie via : Alertmanager (si configurÃ©) OU Grafana Unified Alerting
#
# âš ï¸ STATUT EN V3
# Ce fichier est COMMENTÃ‰ dans prometheus.yml car alerting gÃ©rÃ© par Grafana.
# ConservÃ© pour rÃ©fÃ©rence pÃ©dagogique et compatibilitÃ© future.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

groups:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“Š GROUPE : Alertes modÃ¨le ML (performance et disponibilitÃ©)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: cv_model_alerts
    # ğŸ·ï¸ Identifiant du groupe (organisationnel, apparaÃ®t dans UI Prometheus)
    # Bonne pratique : regrouper par domaine (model, infra, business)
    
    interval: 30s
    # â±ï¸ FrÃ©quence d'Ã©valuation des rÃ¨gles de CE groupe
    # Override du global evaluation_interval (15s dans prometheus.yml)
    # 
    # ğŸ’¡ POURQUOI 30s ?
    # Alertes moins critiques que dÃ©faut (tolÃ©rance dÃ©lai +15s)
    # Alternative : 15s pour alertes critiques, 60s pour warnings
    
    rules:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸš¨ ALERTE 3 : Base de donnÃ©es dÃ©connectÃ©e
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - alert: alert_high_latency
        expr: rate(cv_inference_time_seconds_sum[5m]) / rate(cv_inference_time_seconds_count[5m]) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Latence Ã©levÃ©e dÃ©tectÃ©e"
          description: "Latence moyenne > 2s pendant 2 minutes"
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - alert: NegativeFeedbackRatioHigh
        expr: (sum by () (rate(cv_user_feedback_total{feedback="0"}[10m])) / sum by () (rate(cv_user_feedback_total[10m]))) * 100 > 50
        for: 10m
        labels:
          severity: critical
          type: feedback
        annotations:
          summary: "Ratio de feedback nÃ©gatif Ã©levÃ©"
          description: "Le ratio de feedback nÃ©gatif est supÃ©rieur Ã  50% sur les 10 derniÃ¨res minutes."
          
      - alert: DatabaseDisconnected
        expr: cv_database_connected == 0
        # ğŸ” EXPRESSION SIMPLE (Gauge binaire)
        # cv_database_connected :
        #   1 = connectÃ© (healthy)
        #   0 = dÃ©connectÃ© (update_db_status(False) appelÃ©)
        #
        # ğŸ’¡ POURQUOI GAUGE (et pas Counter) ?
        # Ã‰tat peut monter ET descendre (connexion rÃ©tablie)
        # Counter = monotone croissant (inadaptÃ© pour Ã©tat binaire)
        
        for: 1m
        # â° DurÃ©e courte (1 min) car incident infra critique
        # TolÃ¨re reconnexions brÃ¨ves (blips rÃ©seau) mais pas pannes prolongÃ©es
        
        labels:
          severity: critical
          # ğŸ”´ CRITICAL car :
          # - FonctionnalitÃ© feedback complÃ¨tement cassÃ©e
          # - Risque perte de donnÃ©es (prÃ©dictions non stockÃ©es)
          # - Indicateur potentiel de problÃ¨me infra plus large
        
        annotations:
          summary: "Database connection lost"
          description: "PostgreSQL is unreachable. Feedback storage disabled."
          # ğŸ’¡ ENRICHISSEMENT POSSIBLE
          # description: |
          #   PostgreSQL unreachable for {{ $activeAt | humanizeDuration }}
          #   Impact: User feedback NOT saved
          #   Actions:
          #   1. Check docker ps (container running?)
          #   2. Check docker logs cv_postgres
          #   3. Verify network: docker exec cv_app ping postgres
          #   4. Check disk space: df -h
          # runbook_url: "https://wiki/runbooks/postgres-down"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ CONCEPTS AVANCÃ‰S (non implÃ©mentÃ©s, pour aller plus loin)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. RECORDING RULES (prÃ©-calcul de queries coÃ»teuses)
#    groups:
#      - name: cv_recording_rules
#        interval: 60s
#        rules:
#          - record: cv:prediction_rate:5m
#            expr: rate(cv_predictions_total[5m])
#    â†’ Stocke rÃ©sultat pour rÃ©utilisation (dashboards, alertes)
#    â†’ Ã‰conomise CPU Prometheus (query complexe exÃ©cutÃ©e 1 fois)
#
# 2. TEMPLATING DANS ANNOTATIONS
#    annotations:
#      description: "Current value: {{ $value | humanize }} (threshold: {{ $threshold }})"
#      instance: "{{ $labels.instance }}"
#    â†’ Variables : $value, $labels, custom functions (humanize, humanizeDuration)
#
# 3. ALERTES MULTI-CONDITIONS (AND/OR)
#    expr: |
#      (rate(cv_predictions_total[5m]) < 0.1)
#      and
#      (cv_database_connected == 1)
#    â†’ Alerte uniquement si DB up ET trafic faible (Ã©carte cause DB down)
#
# 4. ALERTES AVEC ABSENT() (dÃ©tection mÃ©trique manquante)
#    expr: absent(cv_predictions_total)
#    â†’ Fire si mÃ©trique n'existe plus (app crashÃ©e, scrape Ã©chouÃ©)
#
# 5. GROUPING PAR LABELS
#    expr: sum by (result) (rate(cv_predictions_total[5m])) < 0.05
#    â†’ Alerte sÃ©parÃ©e pour cats ET dogs (dÃ©tection dÃ©sÃ©quilibre)
#
# 6. EXTERNAL LABELS (identification source)
#    Dans prometheus.yml :
#      global:
#        external_labels:
#          cluster: 'production'
#          datacenter: 'eu-west-1'
#    â†’ Utile si fÃ©dÃ©ration multi-Prometheus (alertes indiquent origine)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸ COMMANDES UTILES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# VALIDATION SYNTAXE
#   promtool check rules alerts.yml
#   â†’ VÃ©rifie YAML + expressions PromQL avant dÃ©ploiement
#
# TEST ALERTE LOCALEMENT
#   promtool test rules test_alerts.yml
#   â†’ Avec fichier test dÃ©finissant sÃ©ries temporelles fictives
#
# VISUALISATION ALERTES ACTIVES
#   http://localhost:9090/alerts
#   â†’ UI Prometheus listant alertes (inactive/pending/firing)
#
# SIMULATION DÃ‰CLENCHEMENT
#   # Forcer mÃ©trique Ã  dÃ©passer seuil (dev uniquement)
#   curl -X POST http://localhost:8000/api/simulate-low-traffic
#   â†’ Endpoint debug dÃ©sactivant prÃ©dictions temporairement
#
# QUERIES DEBUG
#   cv_database_connected  # Valeur actuelle gauge
#   ALERTS{alertname="DatabaseDisconnected"}  # Ã‰tat alerte (0 ou 1)
#   ALERTS{alertstate="firing"}  # Toutes alertes firing
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š RESSOURCES PÃ‰DAGOGIQUES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# - Alerting rules: https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/
# - PromQL functions: https://prometheus.io/docs/prometheus/latest/querying/functions/
# - Histogram quantiles: https://prometheus.io/docs/practices/histograms/
# - Severity levels: https://www.atlassian.com/incident-management/kpis/severity-levels
# - SLO/SLA design: https://sre.google/workbook/implementing-slos/
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¯ AMÃ‰LIORATION CONTINUE - EXAMPLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. AFFINER SEUILS (aprÃ¨s collecte donnÃ©es rÃ©elles)
#    - P95 latency : ajuster selon SLA contractuel
#    - Feedback rate : baseline sur 30 jours de prod
#    - Prediction rate : distinguer heures pleines/creuses
#
# 2. AJOUTER RUNBOOKS
#    - Documenter procÃ©dures debugging pour chaque alerte
#    - Lier via runbook_url dans annotations
#    - Inclure commands exactes (pas de "vÃ©rifier logs")
#
# 3. ALERTES BUSINESS SUPPLÃ‰MENTAIRES
#    - alert: ModelAccuracyDegraded (si tracking accuracy temps rÃ©el)
#    - alert: UnbalancedPredictions (ratio cats/dogs hors norme)
#    - alert: HighErrorRate (predictions_total{result="error"})
#
# 4. INTÃ‰GRATION ALERTMANAGER
#    - Grouping : regrouper alertes similaires (Ã©vite spam)
#    - Routing : warnings â†’ email, critical â†’ PagerDuty
#    - Silences : dÃ©sactiver temporairement (maintenance planifiÃ©e)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•